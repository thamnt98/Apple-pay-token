<!DOCTYPE html>
<html>
<head>
  <title>Apple Pay PaymentData Sender</title>
</head>
<body>
  <button id="apple-pay-button" style="display:none;">Pay with Apple Pay</button>

<script>
  if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
    document.getElementById('apple-pay-button').style.display = 'inline-block';
  }

  document.getElementById('apple-pay-button').addEventListener('click', () => {
    const paymentRequest = {
      countryCode: 'CA',
      currencyCode: 'CAD',
      total: { label: 'Demo Payment', amount: '1.00' },
      supportedNetworks: ['visa', 'masterCard', 'amex'],
      merchantCapabilities: ['supports3DS']
    };

    const session = new ApplePaySession(3, paymentRequest);

    session.onvalidatemerchant = (event) => {
      fetch('/validate-merchant', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ validationUrl: event.validationURL })  // Gửi đúng validationUrl
      })
      .then(res => res.json())
      .then(data => {
        session.completeMerchantValidation(data);
      })
      .catch(err => {
        console.error(err);
        session.abort();
      });
    };

    session.onpaymentauthorized = (event) => {
      const paymentData = event.payment.token.paymentData;
      console.log('Payment Data:', paymentData);
      session.completePayment(ApplePaySession.STATUS_SUCCESS);
    };

    session.begin();
  });
</script>
</body>
</html>
