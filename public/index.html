<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apple Pay Demo</title>
</head>
<body>
<h1>Apple Pay Demo</h1>
<button id="apple-pay-button">Pay with Apple Pay</button>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const button = document.getElementById('apple-pay-button');

        if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
            button.style.display = 'inline-block';
        } else {
            button.style.display = 'none';
            console.warn('Apple Pay is not available on this device/browser.');
        }

        button.addEventListener('click', async () => {
            const paymentRequest = {
                countryCode: 'CA',
                currencyCode: 'CAD',
                supportedNetworks: ['visa', 'masterCard', 'amex'],
                merchantCapabilities: ['supports3DS'],
                merchantIdentifier: process.env.DOMAIN_NAME, // <-- đúng với Apple Merchant ID
                total: {
                    label: 'My Demo Store',
                    amount: '1.00'
                }
            };

            const session = new ApplePaySession(3, paymentRequest);

            session.onvalidatemerchant = async (event) => {
                const res = await fetch('/validate-merchant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const merchantSession = await res.json();
                session.completeMerchantValidation(merchantSession);
            };

            session.onpaymentauthorized = async (event) => {
                const paymentToken = event.payment.token;

                console.log('✅ Payment token:', paymentToken);

                // Optional: gửi về webhook để test
                await fetch('https://webhook.site/your-custom-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: paymentToken })
                });

                session.completePayment(ApplePaySession.STATUS_SUCCESS);
            };

            session.begin();
        });
    });
</script>
</body>
</html>
