<!DOCTYPE html>
<html>
<head>
  <title>Apple Pay Payment with Adyen SDK</title>
</head>
<body>
  <h2>Nhập số tiền cần thanh toán (CAD):</h2>
  <input type="number" id="amount" placeholder="Ví dụ: 1.00" step="0.01" min="0.01" />
  <br><br>
  <button id="apple-pay-button" style="display:none;">Pay with Apple Pay</button>

  <script>
    if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
      document.getElementById('apple-pay-button').style.display = 'inline-block';
    }

    document.getElementById('apple-pay-button').addEventListener('click', () => {
      const amount = document.getElementById('amount').value;

      if (!amount || parseFloat(amount) <= 0) {
        alert('Vui lòng nhập số tiền hợp lệ');
        return;
      }

      const paymentRequest = {
        countryCode: 'CA',
        currencyCode: 'CAD',
        total: {
          label: 'Demo Payment',
          amount: parseFloat(amount).toFixed(2)
        },
        supportedNetworks: ['visa', 'masterCard', 'amex'],
        merchantCapabilities: ['supports3DS']
      };

      const session = new ApplePaySession(3, paymentRequest);

      session.onvalidatemerchant = (event) => {
        fetch('/validate-merchant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ validationURL: event.validationURL })
        })
        .then(res => res.json())
        .then(merchantSession => {
          session.completeMerchantValidation(merchantSession);
        })
        .catch(err => {
          console.error('Merchant validation failed:', err);
          session.abort();
        });
      };

      session.onpaymentauthorized = (event) => {
        const paymentData = event.payment.token.paymentData;
        console.log('Payment Data:', paymentData);

        // Gửi paymentData lên webhook nếu cần
        fetch('https://webhook.site/c37ecbc0-d876-4b23-99b8-27d428d713e6', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ paymentData })
        });

        session.completePayment(ApplePaySession.STATUS_SUCCESS);
      };

      session.begin();
    });
  </script>
</body>
</html>
