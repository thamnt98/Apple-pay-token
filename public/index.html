<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apple Pay Demo</title>
</head>
<body>
  <h1>Apple Pay Demo</h1>
  <input type="number" id="amount" placeholder="Enter amount" />
  <button id="pay-button">Pay with Apple Pay</button>

  <script>
    document.getElementById("pay-button").addEventListener("click", async () => {
      if (!window.ApplePaySession || !ApplePaySession.canMakePayments()) {
        alert("Apple Pay is not available.");
        return;
      }

      const amount = document.getElementById("amount").value;
      if (!amount || parseFloat(amount) <= 0) {
        alert("Please enter a valid amount.");
        return;
      }

      const paymentRequest = {
        countryCode: "CA",
        currencyCode: "CAD",
        supportedNetworks: ["visa", "masterCard", "amex"],
        merchantCapabilities: ["supports3DS"],
        total: {
          label: "Demo Store",
          amount: amount
        }
      };

      const session = new ApplePaySession(3, paymentRequest);

      session.onvalidatemerchant = async (event) => {
    console.log("Validating merchant...");
    try {
        const response = await fetch("/api/apple-pay-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
        });
        if (!response.ok) throw new Error("Failed to fetch merchant session");

        const { session: merchantSession } = await response.json();
        console.log("Merchant session received:", merchantSession);

        session.completeMerchantValidation(merchantSession);
    } catch (err) {
        alert("Merchant validation failed", err);
        console.error("Merchant validation error:", err);
        session.abort();
    }
    };

      session.onpaymentauthorized = async (event) => {
        alert("Payment authorized");
        const token = event.payment.token;
        try {
          await fetch("/api/forward-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token })
          });
          session.completePayment(ApplePaySession.STATUS_SUCCESS);
        } catch (err) {
          alert("Error forwarding token: " + err.message);
          console.error("Error forwarding token:", err);
          session.completePayment(ApplePaySession.STATUS_FAILURE);
        }
      };

      session.onpaymentrejected = async (event) => {
        alert("Payment rejected: " + event.payment.status);
        session.completePayment(ApplePaySession.STATUS_FAILURE);
      };

      session.oncancel = async (event) => {
        alert("Payment canceled: " + event);
        session.completePayment(ApplePaySession.STATUS_FAILURE);
      };

      session.onError = async (event) => {
        alert("Payment error: " + event.error.message);
        session.completePayment(ApplePaySession.STATUS_FAILURE);
      };

      session.begin();
    });
  </script>
</body>
</html>
