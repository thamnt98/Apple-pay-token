<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Apple Pay Demo</title>
  <script>
    async function startApplePay() {
      const amount = document.getElementById("amount").value;

      if (!window.ApplePaySession || !ApplePaySession.canMakePayments()) {
        alert("Apple Pay is not available.");
        return;
      }

      const sessionRequest = await fetch("/api/apple-pay-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount }),
      });
      const { session } = await sessionRequest.json();

      const paymentRequest = {
        countryCode: "US",
        currencyCode: "USD",
        supportedNetworks: ["visa", "masterCard", "amex"],
        merchantCapabilities: ["supports3DS"],
        total: {
          label: "Demo Store",
          amount: amount,
        },
      };

      const sessionApplePay = new ApplePaySession(3, paymentRequest);

      sessionApplePay.onvalidatemerchant = async (event) => {
        sessionApplePay.completeMerchantValidation(session);
      };

      sessionApplePay.onpaymentauthorized = async (event) => {
        const token = event.payment.token;

        // Gửi token về server để gửi đến webhook
        await fetch("/api/forward-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token }),
        });

        sessionApplePay.completePayment(ApplePaySession.STATUS_SUCCESS);
      };

      sessionApplePay.begin();
    }
  </script>
</head>
<body>
  <h2>Apple Pay Demo</h2>
  <input type="number" id="amount" placeholder="Amount in USD" min="1" />
  <button onclick="startApplePay()">Pay with Apple Pay</button>
</body>
</html>
