<!DOCTYPE html>
<html>
<head>
  <title>Apple Pay PaymentData Sender</title>
</head>
<body>
  <button id="apple-pay-button" style="display:none;">Pay with Apple Pay</button>

  <script>
    // Kiá»ƒm tra Apple Pay kháº£ dá»¥ng
    if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
      document.getElementById('apple-pay-button').style.display = 'inline-block';
    }

    document.getElementById('apple-pay-button').addEventListener('click', () => {
      const paymentRequest = {
        countryCode: 'CA',
        currencyCode: 'CAD',
        total: {
          label: 'Demo Payment',
          amount: '1.00'
        },
        supportedNetworks: ['visa', 'masterCard', 'amex'],
        merchantCapabilities: ['supports3DS']
      };

      const session = new ApplePaySession(3, paymentRequest);

      // Khi Apple Pay UI Ä‘Æ°á»£c hiá»ƒn thá»‹ vÃ  ngÆ°á»i dÃ¹ng chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n
      session.onvalidatemerchant = (event) => {
        // á»ž Ä‘Ã¢y báº¡n pháº£i validate merchant vá»›i Apple server, 
        // thÆ°á»ng gá»i API backend Ä‘á»ƒ tráº£ vá» merchantSession tá»« Apple.
        // VÃ¬ báº¡n há»i frontend khÃ´ng certificate, mÃ¬nh sáº½ tráº£ vá» error hoáº·c dummy merchant session
        // Thá»±c táº¿ báº¡n cáº§n lÃ m bÆ°á»›c nÃ y server-side Ä‘á»ƒ láº¥y merchant session.
        fetch('/validate-merchant', {  // Pháº£i cÃ³ API validate merchant session trÃªn server
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
        })
        .then(res => res.json())
        .then(data => {
            alert('ðŸ” merchantSession from server:', data);
            session.completeMerchantValidation(data);
})
        .catch(() => session.abort());
      };

      // Khi ngÆ°á»i dÃ¹ng hoÃ n táº¥t thanh toÃ¡n (nháº¥n Confirm)
      session.onpaymentauthorized = (event) => {
        // Láº¥y paymentData
        const paymentData = event.payment.token.paymentData;

        console.log('Payment Data:', paymentData);

        // Gá»­i paymentData lÃªn webhook
        // fetch('https://webhook.site/c37ecbc0-d876-4b23-99b8-27d428d713e6', {
        //   method: 'POST',
        //   headers: {
        //     'Content-Type': 'application/json'
        //   },
        //   body: JSON.stringify({
        //     paymentData: paymentData
        //   })
        // }).then(response => {
        //   if (response.ok) {
        //     session.completePayment(ApplePaySession.STATUS_SUCCESS);
        //   } else {
        //     session.completePayment(ApplePaySession.STATUS_FAILURE);
        //   }
        // }).catch(() => {
        //   session.completePayment(ApplePaySession.STATUS_FAILURE);
        // });
            session.completePayment(ApplePaySession.STATUS_SUCCESS);
      };

      session.begin();
    });
  </script>
</body>
</html>
