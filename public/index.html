<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Apple Pay Component</title>
  <script src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/5.53.0/adyen.js"></script>
  <link rel="stylesheet" href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/5.53.0/adyen.css" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 10px; font-size: 16px; }
    #applepay-container { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Thanh toán bằng Apple Pay</h2>

  <form id="payment-form">
    <label>Nhập số tiền (CAD): </label>
    <input type="number" id="amount" min="1" required />
    <button type="submit">Tiếp tục</button>
  </form>

  <div id="applepay-container"></div>

  <script>
    const form = document.getElementById("payment-form");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const amountValue = document.getElementById("amount").value;

      if (!amountValue || isNaN(amountValue) || amountValue <= 0) {
        alert("Vui lòng nhập số tiền hợp lệ.");
        return;
      }

      const amountInCents = parseInt(amountValue * 100);

      // Lấy clientKey từ server
      const { clientKey } = await fetch("/config").then(res => res.json());

      // Gửi số tiền đến server để lấy danh sách payment methods (bao gồm Apple Pay)
      const paymentMethodsResponse = await fetch("/paymentMethods", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: {
            currency: "CAD",
            value: amountInCents,
          },
        }),
      }).then(res => res.json());

      // Khởi tạo Adyen Checkout
      const checkout = await AdyenCheckout({
        environment: "test",
        clientKey,
        paymentMethodsResponse,
        onSubmit: async (state) => {
          const res = await fetch("/submit-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
            paymentData: state.data.paymentMethod,
            riskData: state.data.riskData,
            amountValue: amountInCents,
            currency: "CAD",
    }),
          });

          const result = await res.json();
          console.log("Webhook response:", result);
          alert("Đã gửi paymentData lên google sheet!");
        },
      });

      // ✅ Truyền amount vào Apple Pay để hiển thị đúng số tiền
      checkout.create("applepay", {
        amount: {
          currency: "CAD",
          value: amountInCents,
        },
      }).mount("#applepay-container");
    });
  </script>
</body>
</html>
